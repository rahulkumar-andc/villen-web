# nginx/rate-limiting.conf - Advanced Rate Limiting Configuration
# Comprehensive rate limiting for DDoS protection and abuse prevention

# Global rate limiting zones
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=20r/s;
limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=admin:10m rate=1r/m;
limit_req_zone $binary_remote_addr zone=upload:10m rate=2r/m;
limit_req_zone $binary_remote_addr zone=search:10m rate=30r/m;

# Connection limiting zones
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
limit_conn_zone $server_name zone=server_conn:10m;

# Burst handling zones
limit_req_zone $binary_remote_addr zone=burst_general:10m rate=50r/s;
limit_req_zone $binary_remote_addr zone=burst_api:10m rate=100r/s;

# IP-based rate limiting
limit_req_zone $binary_remote_addr zone=ip_general:10m rate=20r/s;
limit_req_zone $binary_remote_addr zone=ip_api:10m rate=50r/s;

# User agent based limiting (for bot detection)
map $http_user_agent $bot_detected {
    default 0;
    ~*(bot|crawler|spider|scraper) 1;
    ~*(sqlmap|nmap|nikto|dirbuster) 1;
}

limit_req_zone $binary_remote_addr$bot_detected zone=bot_limit:10m rate=1r/m;

# Geographic rate limiting (requires geoip module)
# map $geoip_country_code $country_rate {
#     default "normal";
#     "CN" "restricted";
#     "RU" "restricted";
#     "IN" "moderate";
# }

# limit_req_zone $binary_remote_addr$country_rate zone=geo_limit:10m rate=5r/s;

# Time-based rate limiting
map $time_hour $time_multiplier {
    default 1;
    "00" 2;  # Double rate during midnight
    "01" 2;
    "02" 2;
    "03" 2;
    "04" 2;
    "05" 2;
    "22" 1.5;  # 1.5x during evening
    "23" 1.5;
}

# Dynamic rate limiting based on request patterns
map $request_uri $endpoint_risk {
    default "low";
    ~*^/api/auth/ "high";
    ~*^/api/admin/ "critical";
    ~*^/api/upload/ "medium";
    ~*^/api/search/ "low";
    ~*^/api/health/ "none";
}

# Adaptive rate limiting
limit_req_zone $binary_remote_addr$endpoint_risk zone=adaptive:10m rate=10r/s;

# Rate limiting application
rate_limiting_rules {
    # General rate limiting
    limit_req zone=general burst=20 nodelay;
    limit_req_status 429;

    # API-specific rate limiting
    location /api/ {
        limit_req zone=api burst=50 nodelay;

        # Authentication endpoints - stricter limits
        location ~ ^/api/auth/ {
            limit_req zone=auth burst=3 nodelay;
        }

        # Admin endpoints - very strict limits
        location ~ ^/api/admin/ {
            limit_req zone=admin burst=1 nodelay;
        }

        # Upload endpoints
        location ~ ^/api/upload/ {
            limit_req zone=upload burst=2 nodelay;
        }

        # Search endpoints
        location ~ ^/api/search/ {
            limit_req zone=search burst=100 nodelay;
        }
    }

    # Static files - higher limits
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        limit_req zone=burst_general burst=200 nodelay;
    }

    # Bot detection and limiting
    if ($bot_detected = 1) {
        limit_req zone=bot_limit burst=1 nodelay;
        return 429;
    }

    # Connection limits
    limit_conn conn_limit 10;
    limit_conn server_conn 100;

    # Burst protection
    limit_req zone=burst_general burst=100 nodelay;
    limit_req zone=burst_api burst=200 nodelay;

    # IP-based limits
    limit_req zone=ip_general burst=50 nodelay;

    # Adaptive limiting based on risk
    if ($endpoint_risk = "high") {
        limit_req zone=adaptive burst=5 nodelay;
    }

    if ($endpoint_risk = "critical") {
        limit_req zone=adaptive burst=1 nodelay;
    }

    # Time-based adjustments
    if ($time_multiplier = 2) {
        limit_req zone=general burst=40 nodelay;
    }

    if ($time_multiplier = 1.5) {
        limit_req zone=general burst=30 nodelay;
    }
}

# DDoS protection
ddos_protection {
    # SYN flood protection
    limit_conn_zone $binary_remote_addr zone=syn_flood:10m;
    limit_conn syn_flood 10;

    # HTTP flood protection
    limit_req_zone $binary_remote_addr zone=http_flood:10m rate=100r/s;
    limit_req zone=http_flood burst=200 nodelay;

    # Slowloris protection
    client_body_timeout 10s;
    client_header_timeout 10s;
    keepalive_timeout 5s;

    # Request limiting
    limit_req_zone $binary_remote_addr zone=request_flood:10m rate=50r/s;
    limit_req zone=request_flood burst=100 nodelay;
}

# Whitelist configuration
geo $whitelist {
    default 0;
    # Add trusted IP ranges
    127.0.0.1 1;
    10.0.0.0/8 1;
    172.16.0.0/12 1;
    192.168.0.0/16 1;
    # Add specific trusted IPs
    # 203.0.113.1 1;
}

# Blacklist configuration
geo $blacklist {
    default 0;
    # Add blocked IP ranges
    # 198.51.100.0/24 1;
    # 203.0.113.0/24 1;
}

# Apply whitelist/blacklist
whitelist_blacklist {
    if ($blacklist = 1) {
        return 403;
    }

    if ($whitelist = 1) {
        # Higher limits for whitelisted IPs
        limit_req zone=general burst=100 nodelay;
    }
}

# Custom error pages for rate limiting
error_page 429 /429.html;
location = /429.html {
    root /var/www/html;
    internal;
    add_header Retry-After 60 always;
}

# Rate limiting monitoring
rate_limit_monitoring {
    # Log rate limit violations
    limit_req_log_level warn;
    limit_req_dry_run off;

    # Custom logging for rate limit events
    log_format rate_limit '$remote_addr - $remote_user [$time_local] "$request" '
                         '$status $body_bytes_sent "$http_referer" '
                         '"$http_user_agent" "$http_x_forwarded_for" '
                         'rate_limit_exceeded zone=$limit_req_zone';

    access_log /var/log/nginx/rate_limit.log rate_limit if=$limit_req_status;
}