# nginx/security-headers.conf - Security Headers Configuration
# Comprehensive security headers for web application protection

# Content Security Policy (CSP)
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://api.github.com wss: https:; media-src 'self'; object-src 'none'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';" always;

# Strict Transport Security (HSTS)
add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

# X-Frame-Options
add_header X-Frame-Options "DENY" always;

# X-Content-Type-Options
add_header X-Content-Type-Options "nosniff" always;

# X-XSS-Protection
add_header X-XSS-Protection "1; mode=block" always;

# Referrer Policy
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Permissions Policy (formerly Feature Policy)
add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), gyroscope=(), accelerometer=(), payment=(), usb=(), magnetometer=(), ambient-light-sensor=(), autoplay=(), encrypted-media=(), fullscreen=(self), picture-in-picture=()" always;

# Cross-Origin Embedder Policy (COEP)
add_header Cross-Origin-Embedder-Policy "require-corp" always;

# Cross-Origin Opener Policy (COOP)
add_header Cross-Origin-Opener-Policy "same-origin" always;

# Cross-Origin Resource Policy (CORP)
add_header Cross-Origin-Resource-Policy "same-origin" always;

# Remove server identification
more_clear_headers Server;
add_header Server "webserver" always;

# Remove X-Powered-By header
more_clear_headers X-Powered-By;

# Cache control for sensitive content
add_header Cache-Control "no-cache, no-store, must-revalidate" always;
add_header Pragma "no-cache" always;
add_header Expires "0" always;

# API-specific security headers
location /api/ {
    # API versioning
    add_header X-API-Version "v1" always;

    # Rate limit headers
    add_header X-RateLimit-Limit "100" always;
    add_header X-RateLimit-Remaining "99" always;
    add_header X-RateLimit-Reset "1609459200" always;

    # CORS headers for API
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-API-Key, X-CSRF-Token" always;
    add_header Access-Control-Max-Age "86400" always;

    # API-specific CSP
    add_header Content-Security-Policy "default-src 'none'; script-src 'none'; style-src 'none'; img-src 'none'; connect-src 'none'; font-src 'none'; object-src 'none'; media-src 'none'; frame-src 'none'; frame-ancestors 'none'; base-uri 'none'; form-action 'none';" always;
}

# Static files security headers
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    # Static files CSP
    add_header Content-Security-Policy "default-src 'none'; script-src 'none'; style-src 'none'; img-src 'none'; connect-src 'none'; font-src 'none'; object-src 'none'; media-src 'none'; frame-src 'none'; frame-ancestors 'none'; base-uri 'none'; form-action 'none';" always;

    # Cache static files aggressively
    add_header Cache-Control "public, max-age=31536000, immutable" always;

    # Remove sensitive headers from static files
    more_clear_headers X-Powered-By;
    more_clear_headers Server;
}

# Admin area security headers
location /admin/ {
    # Stricter CSP for admin
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; object-src 'none'; frame-ancestors 'none'; base-uri 'self';" always;

    # Additional admin security
    add_header X-Admin-Access "restricted" always;
}

# Login page security headers
location ~ ^/(login|auth)/ {
    # Stricter CSP for authentication
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self'; connect-src 'self'; object-src 'none'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';" always;

    # Prevent caching of auth pages
    add_header Cache-Control "no-cache, no-store, must-revalidate, private" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
}

# File upload security headers
location /upload/ {
    # File upload CSP
    add_header Content-Security-Policy "default-src 'none'; script-src 'none'; style-src 'none'; img-src 'none'; connect-src 'none'; font-src 'none'; object-src 'none'; media-src 'none'; frame-src 'none'; frame-ancestors 'none'; base-uri 'none'; form-action 'self';" always;

    # Prevent MIME sniffing for uploads
    add_header X-Content-Type-Options "nosniff" always;
}

# Error pages security headers
error_page 403 /403.html;
error_page 404 /404.html;
error_page 429 /429.html;
error_page 500 /500.html;

location ~ ^/(403|404|429|500)\.html$ {
    # Error pages CSP
    add_header Content-Security-Policy "default-src 'none'; script-src 'none'; style-src 'none'; img-src 'none'; connect-src 'none'; font-src 'none'; object-src 'none'; media-src 'none'; frame-src 'none'; frame-ancestors 'none'; base-uri 'none'; form-action 'none';" always;

    # Prevent caching of error pages
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
}

# Health check endpoint headers
location /health/ {
    # Minimal headers for health checks
    add_header Content-Security-Policy "default-src 'none';" always;
    add_header Cache-Control "no-cache" always;
}

# Security headers for different content types
map $sent_http_content_type $security_headers {
    default "standard";
    "~*text/html" "html";
    "~*application/json" "api";
    "~*text/javascript" "javascript";
    "~*text/css" "css";
    "~*image/" "image";
    "~*font/" "font";
}

# Apply content-type specific headers
content_type_headers {
    if ($security_headers = "html") {
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
    }

    if ($security_headers = "api") {
        add_header X-Content-Type-Options "nosniff" always;
        add_header Access-Control-Allow-Origin "*" always;
    }

    if ($security_headers = "javascript") {
        add_header X-Content-Type-Options "nosniff" always;
        add_header Cache-Control "public, max-age=31536000, immutable" always;
    }

    if ($security_headers = "css") {
        add_header X-Content-Type-Options "nosniff" always;
        add_header Cache-Control "public, max-age=31536000, immutable" always;
    }

    if ($security_headers = "image") {
        add_header X-Content-Type-Options "nosniff" always;
        add_header Cache-Control "public, max-age=31536000, immutable" always;
    }

    if ($security_headers = "font") {
        add_header X-Content-Type-Options "nosniff" always;
        add_header Cache-Control "public, max-age=31536000, immutable" always;
    }
}

# Custom security headers based on user role (requires auth integration)
# map $cookie_user_role $role_headers {
#     default "standard";
#     "admin" "admin";
#     "moderator" "moderator";
# }

# role_based_headers {
#     if ($role_headers = "admin") {
#         add_header X-User-Role "admin" always;
#         add_header X-Admin-Access "granted" always;
#     }
# }

# Monitoring headers for security analysis
add_header X-Security-Scan "passed" always;
add_header X-Request-ID "$request_id" always;