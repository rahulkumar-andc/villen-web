# nginx/waf-rules.conf - Web Application Firewall Rules
# Comprehensive WAF rules for nginx

# Geo-blocking (block high-risk countries)
# Uncomment and customize based on your needs
# geo $blocked_country {
#     default 0;
#     # High-risk countries (customize as needed)
#     1.0.4.0/22 1;    # Example: Block certain ranges
#     1.0.8.0/21 1;
# }

# Bot detection
map $http_user_agent $is_bot {
    default 0;
    ~*(bot|crawl|spider|slurp|scanner|python|java|curl|wget) 1;
    ~*(sqlmap|nikto|dirbuster|hydra|nmap|masscan|zmap) 1;
}

# Known malicious patterns
map $request_uri $malicious_uri {
    default 0;
    ~*(<|>|('|)|(%3C)|(%3E)|(%27)|(%22)) 1;  # XSS attempts
    ~*(\.\./|\.\.\\|%2e%2e%2f) 1;            # Directory traversal
    ~*(union.*select|select.*from.*information_schema) 1;  # SQL injection
    ~*(eval\(|base64_decode|system\(|exec\() 1;  # Code injection
    ~*(phpmyadmin|adminer|wp-admin|administrator) 1;  # Common attack targets
    ~*(\.env|\.git|\.svn|\.DS_Store|web\.config|crossdomain\.xml) 1;  # Sensitive files
}

# Suspicious request methods
map $request_method $suspicious_method {
    default 0;
    ~(TRACE|TRACK|CONNECT) 1;
}

# Rate limiting for suspicious requests
limit_req_zone $binary_remote_addr zone=suspicious:10m rate=1r/m;

# Main WAF rules
sec_rules {
    # Block known malicious user agents
    if ($http_user_agent ~* "(sqlmap|nikto|dirbuster|hydra|nmap|masscan|zmap|metasploit)") {
        return 403;
    }

    # Block suspicious request methods
    if ($suspicious_method) {
        return 405;
    }

    # Block directory traversal attempts
    if ($request_uri ~* "\.\./") {
        return 403;
    }

    # Block access to backup files
    if ($request_uri ~* "\.(bak|backup|old|orig|swp|swo)$") {
        return 403;
    }

    # Block script execution attempts
    if ($request_uri ~* "\.(php|asp|jsp|exe|bat|cmd)$") {
        return 403;
    }

    # Block requests with suspicious headers
    if ($http_x_forwarded_for ~* "127\.0\.0\.1|localhost|::1") {
        return 403;
    }

    # Block requests with multiple X-Forwarded-For headers (proxy abuse)
    if ($http_x_forwarded_for ~* ",") {
        set $multiple_xff 1;
    }
    if ($multiple_xff) {
        return 403;
    }

    # Block extremely long URIs (potential buffer overflow)
    if ($request_uri ~* ".{2048,}") {
        return 414;
    }

    # Block requests with null bytes
    if ($request_uri ~* "%00") {
        return 403;
    }

    # Block requests with suspicious encoding
    if ($request_uri ~* "%0d%0a") {
        return 403;
    }

    # SQL Injection patterns
    if ($args ~* "(union.*select|select.*from.*information_schema|script.*src)") {
        return 403;
    }

    # XSS patterns in query parameters
    if ($args ~* "(<|>|('|)|javascript:|vbscript:|onload|onerror)") {
        return 403;
    }

    # Block image hotlinking (optional)
    # if ($http_referer !~ "^(https?://)?($server_name|yourdomain\.com)") {
    #     if ($request_uri ~* "\.(jpg|jpeg|png|gif|svg)$") {
    #         return 403;
    #     }
    # }

    # Rate limit suspicious requests
    if ($malicious_uri) {
        limit_req zone=suspicious burst=1 nodelay;
        return 429;
    }

    # Log suspicious activities
    if ($is_bot) {
        access_log /var/log/nginx/bot_access.log;
    }
}

# API-specific WAF rules
api_sec_rules {
    # Stricter rules for API endpoints

    # Block common API abuse patterns
    if ($request_uri ~* "/api/.*\.(php|asp|jsp|exe)$") {
        return 403;
    }

    # Block API enumeration attempts
    if ($request_uri ~* "/api/(admin|config|debug|test|phpmyadmin)") {
        return 403;
    }

    # Block GraphQL introspection in production
    if ($request_method = POST) {
        if ($request_body ~* "__schema|__type") {
            return 403;
        }
    }

    # Rate limit API authentication attempts
    if ($request_uri ~* "/api/auth/|/api/login") {
        limit_req zone=auth burst=5 nodelay;
    }

    # Block API requests with suspicious content types
    if ($http_content_type ~* "(multipart/form-data.*boundary.*;|\.\./)") {
        return 403;
    }

    # Validate API key format (if using X-API-Key header)
    if ($http_x_api_key !~* "^[a-f0-9]{64}$") {
        # Allow requests without API key for public endpoints
        # return 401;
    }

    # Block requests with malformed JSON
    if ($http_content_type ~* "application/json") {
        if ($request_body !~* "^\s*\{.*\}\s*$") {
            return 400;
        }
    }
}