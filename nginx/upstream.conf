# nginx/upstream.conf - Backend Upstream Configuration
# Load balancing and backend server configuration

# Backend upstream servers
upstream backend {
    # Primary backend server
    server backend:8000;

    # Additional backend servers for load balancing (uncomment when scaling)
    # server backend2:8000;
    # server backend3:8000;

    # Load balancing method
    least_conn;

    # Health checks
    health_check interval=10s fails=3 passes=2 uri=/api/health/;

    # Session persistence (if needed)
    # ip_hash;

    # Connection limits
    keepalive 32;
    keepalive_timeout 30s;
    keepalive_requests 100;
}

# Database upstream (if direct database access needed - NOT recommended for production)
# upstream database {
#     server db:5432;
#     # Only enable if absolutely necessary and with proper security
# }

# Redis upstream (for caching/session storage)
upstream redis_cache {
    server redis:6379;
    # Redis connection settings
    keepalive 16;
    keepalive_timeout 30s;
}

# File storage upstream (if using separate file server)
# upstream file_server {
#     server files:8080;
# }

# Monitoring upstream
upstream monitoring {
    server monitoring:9090;
    # Prometheus/Grafana or similar
}

# Load balancer configuration
upstream load_balancer {
    # Multiple nginx instances for high availability
    server nginx1:80;
    server nginx2:80;
    server nginx3:80;

    # Health checks for load balancer nodes
    health_check interval=5s fails=2 passes=1;
}

# API gateway upstream (if using API gateway)
# upstream api_gateway {
#     server gateway:8080;
#     health_check interval=10s fails=3 passes=2 uri=/health;
# }

# CDN upstream (for static assets)
# upstream cdn {
#     server cdn1.example.com;
#     server cdn2.example.com;
#     server cdn3.example.com;
# }

# Upstream security settings
upstream_security {
    # Backend connection security
    proxy_connect_timeout 10s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;

    # Buffer settings
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;

    # Request limits
    proxy_request_buffering on;
    proxy_max_temp_file_size 1024m;
    proxy_temp_file_write_size 64k;

    # Security headers
    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;

    # SSL verification for upstream
    # proxy_ssl_verify on;
    # proxy_ssl_verify_depth 2;
    # proxy_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
}

# Failover configuration
upstream_failover {
    # Backup servers
    server backup1:8000 backup;
    server backup2:8000 backup;

    # Failover settings
    max_fails 3;
    fail_timeout 30s;
}

# Dynamic upstream configuration (requires nginx-plus or lua module)
# lua_shared_dict upstream_cache 1m;
# lua_code_cache on;

# init_by_lua_block {
#     local upstream = require "ngx.upstream"
#     -- Dynamic upstream management code
# }

# Monitoring and metrics
upstream_monitoring {
    # Track upstream response times
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;

    # Log upstream metrics
    log_format upstream_log '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for" '
                          'rt=$request_time ua="$upstream_addr" '
                          'us="$upstream_status" ut="$upstream_response_time" '
                          'ul="$upstream_response_length"';

    access_log /var/log/nginx/upstream.log upstream_log;
}

# Rate limiting for upstream connections
upstream_rate_limiting {
    # Limit connections per upstream server
    limit_conn upstream_conn 100;

    # Rate limit requests to upstream
    limit_req zone=upstream burst=100 nodelay;
}

# Upstream connection pooling
upstream_connection_pooling {
    # Keep connections alive
    keepalive 100;
    keepalive_timeout 60s;
    keepalive_requests 1000;

    # Connection reuse
    proxy_http_version 1.1;
    proxy_set_header Connection "";
}