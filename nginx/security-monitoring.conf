# nginx/security-monitoring.conf - Security Event Monitoring
# Comprehensive logging and monitoring for security events

# Security event logging format
log_format security_log escape=json
    '{'
        '"timestamp":"$time_iso8601",'
        '"client_ip":"$remote_addr",'
        '"client_port":"$remote_port",'
        '"host":"$host",'
        '"request_method":"$request_method",'
        '"request_uri":"$request_uri",'
        '"request_length":"$request_length",'
        '"status":"$status",'
        '"bytes_sent":"$bytes_sent",'
        '"referer":"$http_referer",'
        '"user_agent":"$http_user_agent",'
        '"request_time":"$request_time",'
        '"upstream_response_time":"$upstream_response_time",'
        '"upstream_addr":"$upstream_addr",'
        '"http_x_forwarded_for":"$http_x_forwarded_for",'
        '"http_x_real_ip":"$http_x_real_ip",'
        '"security_threat":"$security_threat",'
        '"threat_level":"$threat_level",'
        '"blocked_reason":"$blocked_reason",'
        '"correlation_id":"$correlation_id",'
        '"session_id":"$session_id"'
    '}';

# Security monitoring zones
limit_req_status_zone $binary_remote_addr zone=security_monitor:10m rate=100r/m;

# Security event detection and logging
security_monitoring {
    # Initialize security variables
    set $security_threat "";
    set $threat_level "low";
    set $blocked_reason "";

    # High-threat indicators
    if ($status = 403) {
        set $security_threat "access_denied";
        set $threat_level "high";
        set $blocked_reason "forbidden_access";
    }

    if ($status = 429) {
        set $security_threat "rate_limit_exceeded";
        set $threat_level "medium";
        set $blocked_reason "rate_limiting";
    }

    if ($status = 401) {
        set $security_threat "unauthorized_access";
        set $threat_level "high";
        set $blocked_reason "authentication_required";
    }

    # Suspicious request patterns
    if ($request_uri ~* "(wp-admin|wp-login|admin|phpmyadmin|mysql)") {
        set $security_threat "cms_probe";
        set $threat_level "high";
        set $blocked_reason "cms_attack_attempt";
    }

    if ($request_uri ~* "(\.\./|\.\.\\|/etc/passwd|/etc/shadow)") {
        set $security_threat "directory_traversal";
        set $threat_level "critical";
        set $blocked_reason "path_traversal";
    }

    if ($args ~* "(select|union|insert|cast|declare|drop|update|md5|benchmark|script|javascript|vbscript|<script)") {
        set $security_threat "injection_attack";
        set $threat_level "critical";
        set $blocked_reason "sql_injection";
    }

    # Bot detection
    if ($http_user_agent ~* "(sqlmap|nmap|nikto|dirbuster|gobuster|masscan|zgrab|acunetix|openvas|nessus)") {
        set $security_threat "security_scanner";
        set $threat_level "high";
        set $blocked_reason "scanner_detected";
    }

    if ($http_user_agent ~* "(bot|crawler|spider|scraper)" && $http_user_agent !~* "(google|bing|yahoo|duckduckgo)") {
        set $security_threat "unauthorized_bot";
        set $threat_level "medium";
        set $blocked_reason "bot_activity";
    }

    # Geographic anomalies (requires geoip module)
    # if ($geoip_country_code !~* "(US|CA|GB|DE|FR|AU)") {
    #     set $security_threat "suspicious_location";
    #     set $threat_level "low";
    # }

    # Time-based anomalies
    if ($time_hour ~* "(02|03|04|05)") {
        if ($request_uri ~* "/admin/") {
            set $security_threat "off_hours_admin";
            set $threat_level "medium";
        }
    }

    # Log security events
    if ($security_threat != "") {
        access_log /var/log/nginx/security_events.log security_log;
    }

    # Send alerts for high/critical threats
    if ($threat_level ~* "(high|critical)") {
        # Could integrate with external monitoring systems
        # Example: njs script to send alerts
        access_log /var/log/nginx/security_alerts.log security_log;
    }

    # Performance monitoring for security checks
    if ($request_time > 5) {
        access_log /var/log/nginx/slow_security.log security_log;
    }
}

# DDoS protection monitoring
ddos_monitoring {
    # Track connection rates
    limit_conn_zone $binary_remote_addr zone=ddos_conn:10m;

    # Monitor for SYN flood patterns
    if ($connection_requests > 100) {
        access_log /var/log/nginx/ddos_events.log security_log;
    }

    # Track request patterns
    if ($requests_per_second > 50) {
        set $security_threat "high_request_rate";
        set $threat_level "medium";
        access_log /var/log/nginx/ddos_events.log security_log;
    }
}

# SSL/TLS monitoring
ssl_monitoring {
    # Log SSL handshake failures
    if ($ssl_handshake_time = "") {
        access_log /var/log/nginx/ssl_failures.log security_log;
    }

    # Monitor SSL protocol versions
    if ($ssl_protocol !~* "(TLSv1.2|TLSv1.3)") {
        set $security_threat "weak_ssl";
        set $threat_level "medium";
        access_log /var/log/nginx/ssl_warnings.log security_log;
    }

    # Log certificate validation issues
    if ($ssl_client_verify != "SUCCESS") {
        access_log /var/log/nginx/ssl_verify.log security_log;
    }
}

# API monitoring
api_monitoring {
    # Track API usage patterns
    if ($request_uri ~* "^/api/") {
        access_log /var/log/nginx/api_usage.log security_log;

        # Monitor for API abuse
        if ($status = 429) {
            set $security_threat "api_rate_limit";
            set $threat_level "medium";
            access_log /var/log/nginx/api_abuse.log security_log;
        }

        # Track authentication failures
        if ($status = 401) {
            set $security_threat "api_auth_failure";
            set $threat_level "high";
            access_log /var/log/nginx/api_auth_failures.log security_log;
        }
    }
}

# Real-time alerting (requires external integration)
# security_alerting {
#     # Send alerts to monitoring system
#     # Example: POST to webhook or write to syslog
#     if ($threat_level = "critical") {
#         # Integration with SIEM, Slack, PagerDuty, etc.
#     }
# }