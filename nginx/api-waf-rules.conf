# nginx/api-waf-rules.conf - API-Specific WAF Rules
# Advanced protection for API endpoints

# API rate limiting by endpoint type
map $request_uri $api_endpoint_type {
    default "general";
    ~*^/api/auth/ "auth";
    ~*^/api/admin/ "admin";
    ~*^/api/feeds/ "public";
    ~*^/api/health/ "health";
}

# Stricter rate limits for sensitive endpoints
limit_req_zone $binary_remote_addr zone=api_auth:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=api_admin:10m rate=1r/m;
limit_req_zone $binary_remote_addr zone=api_general:10m rate=20r/m;

# API security rules
api_security {
    # Authentication required for protected endpoints
    if ($request_uri ~* "^/api/(?!health|feeds)") {
        # Check for authentication headers
        if ($http_authorization !~* "^(Bearer|Token)") {
            if ($http_x_api_key = "") {
                return 401;
            }
        }
    }

    # Validate Content-Type for POST/PUT/PATCH
    if ($request_method ~* "(POST|PUT|PATCH)") {
        if ($http_content_type !~* "^application/json") {
            if ($http_content_type !~* "^multipart/form-data") {
                return 415;
            }
        }
    }

    # Block oversized requests
    if ($content_length > 10485760) {  # 10MB limit
        return 413;
    }

    # Validate JSON structure for API requests
    if ($http_content_type ~* "application/json") {
        # Basic JSON validation (more advanced validation in application)
        if ($request_body !~* "^\s*[\[\{]") {
            return 400;
        }
    }

    # API-specific attack patterns
    if ($request_uri ~* "/api/.*(drop|delete|update|insert).*table") {
        return 403;
    }

    if ($request_uri ~* "/api/.*(union|select|script|javascript|vbscript)") {
        return 403;
    }

    # Block API discovery attempts
    if ($request_uri ~* "/api/(v[0-9]+/)?api") {
        return 403;
    }

    # Rate limiting based on endpoint type
    if ($api_endpoint_type = "auth") {
        limit_req zone=api_auth burst=3 nodelay;
    }

    if ($api_endpoint_type = "admin") {
        limit_req zone=api_admin burst=1 nodelay;
    }

    if ($api_endpoint_type = "general") {
        limit_req zone=api_general burst=10 nodelay;
    }

    # Allow health checks without rate limiting
    if ($api_endpoint_type = "health") {
        # No rate limiting for health checks
    }

    # Public feeds with moderate rate limiting
    if ($api_endpoint_type = "public") {
        limit_req zone=api_general burst=50 nodelay;
    }

    # API versioning validation
    if ($http_accept ~* "application/vnd\.villen\.") {
        # Extract version from Accept header
        set $api_version $1 if ($http_accept ~* "application/vnd\.villen\.([a-zA-Z0-9]+)");
        if ($api_version !~* "^v[0-9]+$") {
            return 406;
        }
    }

    # CORS validation for API requests
    if ($http_origin !~* "^https?://(localhost|127\.0\.0\.1|yourdomain\.com)") {
        if ($request_method !~* "(GET|HEAD|OPTIONS)") {
            return 403;
        }
    }

    # Log API security events
    access_log /var/log/nginx/api_security.log security;

    # Add API-specific security headers
    add_header X-API-Version "v1" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;

    # API response caching (for GET requests)
    if ($request_method = "GET") {
        add_header Cache-Control "private, max-age=300" always;
    }
}

# GraphQL-specific protection (if using GraphQL)
graphql_protection {
    # Block GraphQL introspection in production
    if ($request_body ~* "__schema|__type|__typename") {
        return 403;
    }

    # Limit query complexity
    if ($request_body ~* "(query|mutation).*\{.*\{.*\{.*\{.*\{") {
        return 429;
    }

    # Block field suggestions
    if ($request_uri ~* "/graphql" && $args ~* "query=") {
        if ($args ~* "__") {
            return 403;
        }
    }
}

# File upload protection
file_upload_protection {
    # Validate file upload requests
    if ($http_content_type ~* "multipart/form-data") {
        # Check file size
        if ($content_length > 5242880) {  # 5MB limit
            return 413;
        }

        # Validate filename (no path traversal)
        if ($request_body ~* "filename=\".*(\.\./|\.\.\\|/)") {
            return 403;
        }

        # Block executable files
        if ($request_body ~* "filename=\".*\.(exe|bat|cmd|scr|pif|com)$") {
            return 403;
        }
    }
}